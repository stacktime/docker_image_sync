# 工作流名称
name: 手动同步镜像至指定仓库

# 工作流运行时显示名称
run-name: ${{ github.actor }} Sync Docker to Hub by Input

# 怎样触发工作流
on:
  # 手动触发
  workflow_dispatch:
    inputs:
      IMAGE_NAME:
        description: '原镜像名称'
        required: true
        default: 'portainer/portainer-ce'
      NEW_NAME:
        description: '同步后镜像名称'
        required: true
        default: 'portainer-ce'
      IMAGE_VERSION:
        description: '镜像版本'
        required: true
        default: 'latest'
      TARGET_REGISTRY:
        description: '推送至仓库地址'
        required: true
        default: 'swr.cn-north-1.myhuaweicloud.com'
      TARGET_ORGANIZATION:
        description: '空间名称'
        required: true
        default: 'wanybo_sync'


# 工作流程任务（通常含有一个或多个步骤）
jobs:
  # 这个任务为 sync_docker_by_input
  sync_docker_by_input:
    name: Sync Images to DockerHub
    # 使用什么环境运行
    runs-on: ubuntu-latest
    # 步骤表示将作为作业的一部分执行的一系列任务
    steps:
      # 签出存储库，以便你的工作可以访问它
      - name: Check out code
        uses: actions/checkout@v4

      # Runs a single command using the runners shell
      - name: Setup Docker buildx
        uses: docker/setup-buildx-action@v3

      # GitHub Action to login against a Docker registry.
      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          registry: ${{ vars.REGISTRY }}
          username: ${{ secrets.REGISTRY_USER }}
          password: ${{ secrets.REGISTRY_PASSWORD }}
          logout: true

      # Runs a set of commands using the runners shell
      - name: Pull and Push Images
        run: |
          docker pull ${{ github.event.inputs.IMAGE_NAME }}:${{ github.event.inputs.IMAGE_VERSION }}
          docker tag ${{ github.event.inputs.IMAGE_NAME }}:${{ github.event.inputs.IMAGE_VERSION }} ${{ github.event.inputs.TARGET_REGISTRY }}/${{ github.event.inputs.TARGET_ORGANIZATION }}/${{ github.event.inputs.NEW_NAME }}:${{ github.event.inputs.IMAGE_VERSION }}
          docker push ${{ github.event.inputs.TARGET_REGISTRY }}/${{ github.event.inputs.TARGET_ORGANIZATION }}/${{ github.event.inputs.NEW_NAME }}:${{ github.event.inputs.IMAGE_VERSION }}